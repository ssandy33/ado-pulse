{$DOMAIN} {
	# TLS: RSA cert + broad cipher suites for corporate proxy compatibility
	# ECDSA certs cause ERR_SSL_VERSION_OR_CIPHER_MISMATCH on networks with
	# SSL inspection proxies that only support RSA key exchange (TLS 1.2)
	tls {
		protocols tls1.2 tls1.3
		ciphers TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
		key_type rsa2048
	}

	# Compression
	encode gzip

	# Security headers
	header {
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "camera=(), microphone=(), geolocation=()"
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self'"
		-Server
	}

	# Basic auth (conditionally injected by entrypoint script)
	# BASIC_AUTH_BLOCK

	# Cache immutable Next.js static assets (content-hashed filenames)
	handle /_next/static/* {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy app:3000
	}

	# Reverse proxy to Next.js app
	handle {
		reverse_proxy app:3000 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
}
