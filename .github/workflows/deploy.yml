name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            mkdir -p ~/.ssh
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
              -i ~/.ssh/deploy_key \
              ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
              'cd /opt/ado-pulse && git fetch origin main && git reset --hard origin/main && mkdir -p data && chown 1001:1001 data && docker compose -f docker-compose.prod.yml build && docker compose -f docker-compose.prod.yml up -d --force-recreate && sleep 15 && docker compose -f docker-compose.prod.yml logs app --tail 30 && echo "--- Direct API test (bypassing Caddy) ---" && docker compose -f docker-compose.prod.yml exec -T app wget -q -O - http://127.0.0.1:3000/api/teams 2>&1 | head -c 500 && echo "" && echo "--- End API test ---" && docker compose -f docker-compose.prod.yml restart caddy && docker compose -f docker-compose.prod.yml ps && docker image prune -f'
            SSH_EXIT=$?
            rm -f ~/.ssh/deploy_key
            exit $SSH_EXIT
