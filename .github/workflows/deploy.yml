name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            mkdir -p ~/.ssh
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
              -i ~/.ssh/deploy_key \
              ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} 'bash -s' <<'ENDSSH'
            set -e
            cd /opt/ado-pulse
            OLD_HEAD=$(git rev-parse HEAD)
            git fetch origin main
            git reset --hard origin/main
            mkdir -p data
            chown 1001:1001 data
            if git diff --name-only "$OLD_HEAD" HEAD | grep -q "deploy/Caddyfile"; then
              echo "Caddyfile changed â€” clearing Caddy TLS cache to force cert re-issuance"
              docker compose -f docker-compose.prod.yml rm -sf caddy
              docker volume rm ado-pulse_caddy_data || true
            fi
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d
            docker compose -f docker-compose.prod.yml restart caddy
            docker compose -f docker-compose.prod.yml ps
            docker image prune -f
            ENDSSH
            SSH_EXIT=$?
            rm -f ~/.ssh/deploy_key
            exit $SSH_EXIT

      - name: Log deployment to Axiom
        if: success()
        env:
          AXIOM_API_TOKEN: ${{ secrets.AXIOM_API_TOKEN }}
          AXIOM_DATASET: ${{ secrets.AXIOM_DATASET || 'ado-pulse' }}
        continue-on-error: true
        run: |
          if [ -n "$AXIOM_API_TOKEN" ]; then
            curl -s --max-time 10 --retry 2 --retry-delay 2 \
              -X POST "https://api.axiom.co/v1/datasets/${AXIOM_DATASET}/ingest" \
              -H "Authorization: Bearer ${AXIOM_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "[{\"_time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"service\":\"ado-pulse\",\"level\":\"info\",\"message\":\"Deployment completed\",\"commit\":\"${{ github.sha }}\",\"ref\":\"${{ github.ref }}\",\"actor\":\"${{ github.actor }}\"}]" \
              || true
          fi
