name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            mkdir -p ~/.ssh
            echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
              -i ~/.ssh/deploy_key \
              ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
              'cd /opt/ado-pulse && git fetch origin main && git reset --hard origin/main && mkdir -p data && chown 1001:1001 data && docker compose -f docker-compose.prod.yml build --no-cache && docker compose -f docker-compose.prod.yml up -d && docker compose -f docker-compose.prod.yml restart caddy && docker compose -f docker-compose.prod.yml ps && docker image prune -f'
            SSH_EXIT=$?
            rm -f ~/.ssh/deploy_key
            exit $SSH_EXIT

      - name: Log deployment to Axiom
        if: success()
        env:
          AXIOM_API_TOKEN: ${{ secrets.AXIOM_API_TOKEN }}
          AXIOM_DATASET: ${{ secrets.AXIOM_DATASET || 'ado-pulse' }}
        run: |
          if [ -n "$AXIOM_API_TOKEN" ]; then
            curl -s -X POST "https://api.axiom.co/v1/datasets/${AXIOM_DATASET}/ingest" \
              -H "Authorization: Bearer ${AXIOM_API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "[{\"_time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"service\":\"ado-pulse\",\"level\":\"info\",\"message\":\"Deployment completed\",\"commit\":\"${{ github.sha }}\",\"ref\":\"${{ github.ref }}\",\"actor\":\"${{ github.actor }}\"}]"
          fi
